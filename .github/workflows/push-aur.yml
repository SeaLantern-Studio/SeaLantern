# å·¥ä½œæµåç§°ï¼šå‘å¸ƒåˆ° AUR
name: Publish to AUR

# è§¦å‘æ¡ä»¶é…ç½®
on:
  # å½“æœ‰æ ‡ç­¾æ¨é€åˆ°ä»“åº“æ—¶è§¦å‘
  push:
    tags:
      - "v*" # åŒ¹é…ä»¥ v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0
      - "sea-lantern-v*" # åŒ¹é…ä»¥ sea-lantern-v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ sea-lantern-v0.6.5

  # å½“æœ‰ Release å‘å¸ƒæ—¶è§¦å‘
  release:
    types: [published] # ä»…åœ¨ Release è¢«å‘å¸ƒæ—¶è§¦å‘

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      version: # æ‰‹åŠ¨è¾“å…¥ç‰ˆæœ¬å·
        description: "æ¨é€çš„ç‰ˆæœ¬å·(e.g., 1.0.0)"
        required: true # ç‰ˆæœ¬å·æ˜¯å¿…å¡«é¡¹
        type: string
      skip_test: # æ˜¯å¦è·³è¿‡æµ‹è¯•
        description: "è·³è¿‡æµ‹è¯•æ­¥éª¤"
        required: false # éå¿…å¡«
        default: false # é»˜è®¤ä¸è·³è¿‡æµ‹è¯•
        type: boolean

# å®šä¹‰å·¥ä½œä»»åŠ¡
jobs:
  aur-publish: # ä»»åŠ¡åç§°
    # ä½¿ç”¨ Arch Linux å®¹å™¨ç›´æ¥è¿è¡Œï¼Œé¿å…åµŒå¥— Docker
    runs-on: ubuntu-latest # è¿è¡Œåœ¨ Ubuntu æœ€æ–°ç‰ˆä¸Š
    container: # åœ¨å®¹å™¨ä¸­è¿è¡Œ
      image: archlinux:latest # ä½¿ç”¨ Arch Linux æœ€æ–°ç‰ˆé•œåƒ
      options: --user root # ä»¥ root ç”¨æˆ·è¿è¡Œ

    # ä»»åŠ¡æ­¥éª¤åˆ—è¡¨
    steps:
      # ç¬¬ä¸€æ­¥ï¼šåœ¨å®¹å™¨ä¸­å®‰è£…ä¾èµ–
      - name: Install dependencies in container
        run: |
          # åˆå§‹åŒ– pacman å¯†é’¥ç¯ï¼ˆArch Linux çš„åŒ…ç®¡ç†å™¨ï¼‰
          pacman-key --init
          pacman-key --populate archlinux

          # ç³»ç»Ÿæ›´æ–°å¹¶å®‰è£…å¿…è¦å·¥å…·
          # --noconfirm è¡¨ç¤ºè‡ªåŠ¨ç¡®è®¤æ‰€æœ‰æç¤º
          # base-devel: åŸºç¡€å¼€å‘å·¥å…·åŒ…
          # git: ç‰ˆæœ¬æ§åˆ¶å·¥å…·
          # sudo: æƒé™æå‡å·¥å…·
          # openssh: SSH å®¢æˆ·ç«¯ï¼Œç”¨äºè¿æ¥ AUR
          # dpkg: Debian åŒ…å·¥å…·ï¼Œç”¨äºå¤„ç† deb åŒ…
          pacman -Syu --noconfirm base-devel git sudo openssh dpkg

          # åˆ›å»º builder ç”¨æˆ·ï¼ˆç”¨äºè¿è¡Œ makepkgï¼‰
          useradd -m builder
          # å…è®¸ builder ç”¨æˆ·æ— å¯†ç æ‰§è¡Œ sudo
          echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

      # ç¬¬äºŒæ­¥ï¼šæ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4 # ä½¿ç”¨å®˜æ–¹ checkout action
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ï¼ŒåŒ…æ‹¬æ‰€æœ‰æ ‡ç­¾

      # ç¬¬ä¸‰æ­¥ï¼šè°ƒè¯• GitHub ä¸Šä¸‹æ–‡ä¿¡æ¯
      - name: Debug GitHub context
        run: |
          echo "GitHubè¾“å‡ºæ—¥å¿—:"
          echo "äº‹ä»¶åç§°: ${{ github.event_name }}"                    # äº‹ä»¶ç±»å‹
          echo "gitå¼•ç”¨: ${{ github.ref }}"                                   # Git å¼•ç”¨
          echo "å¼•ç”¨ç±»å‹: ${{ github.ref_type }}"                         # å¼•ç”¨ç±»å‹ï¼ˆbranch/tagï¼‰
          echo "å¼•ç”¨åç§°: ${{ github.ref_name }}"                         # å¼•ç”¨åç§°
          echo "Releaseæ ‡ç­¾: ${{ github.event.release.tag_name }}"       # Release æ ‡ç­¾
          echo "ä»“åº“åç§°: ${{ github.repository }}"                     # ä»“åº“åç§°
          echo "è§¦å‘è€…: ${{ github.actor }}"                               # è§¦å‘è€…

      # ç¬¬å››æ­¥ï¼šè·å–ç‰ˆæœ¬å·
      - name: Get release version
        id: get_version # è®¾ç½®æ­¥éª¤ IDï¼Œåç»­å¯ä»¥é€šè¿‡ steps.get_version.outputs å¼•ç”¨
        run: |
          # æ ¹æ®äº‹ä»¶ç±»å‹è·å–ç‰ˆæœ¬
          if [[ "${{ github.event_name }}" == "release" ]]; then
            # Release äº‹ä»¶ï¼šä» release tag è·å–
            RAW_VERSION="${{ github.event.release.tag_name }}"
            echo "Source: release tag: $RAW_VERSION"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            # Push äº‹ä»¶ï¼šä» Git å¼•ç”¨åè·å–
            RAW_VERSION="${{ github.ref_name }}"
            echo "Source: git tag: $RAW_VERSION"
          else
            # æ‰‹åŠ¨è§¦å‘ï¼šä»è¾“å…¥å‚æ•°è·å–
            RAW_VERSION="${{ github.event.inputs.version }}"
            echo "Source: manual input: $RAW_VERSION"
          fi

          # æå–çº¯å‡€ç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ç­‰ï¼‰
          if [[ $RAW_VERSION =~ [0-9]+\.[0-9]+\.[0-9]+ ]]; then
            # å¦‚æœåŒ…å«ç‰ˆæœ¬å·æ¨¡å¼ï¼Œæå–çº¯æ•°å­—ç‰ˆæœ¬
            VERSION=$(echo "$RAW_VERSION" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
            echo "Extracted version from tag: $VERSION"
          else
            # å¦åˆ™ç›´æ¥å»æ‰ v å‰ç¼€
            VERSION="${RAW_VERSION#v}"
          fi

          # éªŒè¯ç‰ˆæœ¬å·ä¸ä¸ºç©º
          if [[ -z "$VERSION" ]]; then
            echo "âŒ Error: Version is empty!"
            exit 1
          fi

          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼ï¼ˆå¿…é¡»æ˜¯ x.y.z æ ¼å¼ï¼‰
          if ! [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Error: Invalid version format: $VERSION"
            exit 1
          fi

          # å°†ç‰ˆæœ¬å·ä¿å­˜åˆ°è¾“å‡ºå’Œç¯å¢ƒå˜é‡
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_ENV
          echo "âœ… Final version: $VERSION"

      # ç¬¬äº”æ­¥ï¼šéªŒè¯ PKGBUILD æ–‡ä»¶å­˜åœ¨
      - name: Validate PKGBUILD exists
        run: |
          if [ ! -f "PKGBUILD" ]; then
            echo "Error: PKGBUILDæ–‡ä»¶æ²¡æœ‰æ‰¾åˆ°!"
            ls -la  # åˆ—å‡ºå½“å‰ç›®å½•å†…å®¹ä»¥ä¾¿è°ƒè¯•
            exit 1
          fi
          echo "âœ… PKGBUILD found"

      # ç¬¬å…­æ­¥ï¼šæ›´æ–° PKGBUILD ä¸­çš„ç‰ˆæœ¬å·
      - name: Update PKGBUILD version
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "Updating PKGBUILD to version: $VERSION"

          # å¤‡ä»½åŸå§‹ PKGBUILD
          cp PKGBUILD PKGBUILD.bak

          # æ›´æ–°ç‰ˆæœ¬å·
          sed -i "s/^pkgver=.*/pkgver=${VERSION}/" PKGBUILD  # æ›¿æ¢ pkgver è¡Œ
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD           # é‡ç½® pkgrel ä¸º 1

          echo "âœ… Updated PKGBUILD"
          echo "New version: $(grep ^pkgver= PKGBUILD)"

      # ç¬¬ä¸ƒæ­¥ï¼šç”Ÿæˆ .SRCINFO æ–‡ä»¶
      - name: Generate .SRCINFO
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "Generating .SRCINFO for version: $VERSION"

          # ä½¿ç”¨ builder ç”¨æˆ·è¿è¡Œ makepkg ç”Ÿæˆ .SRCINFO
          chown -R builder:builder .  # æ›´æ”¹æ–‡ä»¶æ‰€æœ‰æƒç»™ builder
          sudo -u builder makepkg --printsrcinfo > .SRCINFO  # ç”Ÿæˆ SRCINFO

          if [ ! -f ".SRCINFO" ]; then
            echo "âŒ generate .SRCINFOå¤±è´¥"
            exit 1
          fi

          echo "âœ… Generated .SRCINFOæˆåŠŸ:"
          cat .SRCINFO  # æ˜¾ç¤ºç”Ÿæˆçš„å†…å®¹ç”¨äºè°ƒè¯•

      # ç¬¬å…«æ­¥ï¼šéªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
      - name: Validate files
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          # éªŒè¯ PKGBUILD ä¸­çš„ç‰ˆæœ¬å·
          PKGVER=$(grep "^pkgver=" PKGBUILD | cut -d= -f2 | xargs)
          if [[ "$PKGVER" != "$VERSION" ]]; then
            echo "âŒ PKGBUILDæ–‡ä»¶ç‰ˆæœ¬å·é”™è¯¯!"
            exit 1
          fi
          echo "âœ… PKGBUILDç‰ˆæœ¬å·æ˜¯: $PKGVER"

          # éªŒè¯ .SRCINFO ä¸­çš„ç‰ˆæœ¬å·
          SRCINFO_VER=$(grep "^[[:space:]]*pkgver =" .SRCINFO | head -1 | awk '{print $3}')
          if [[ "$SRCINFO_VER" != "$VERSION" ]]; then
            echo "âŒ .SRCINFOç‰ˆæœ¬å·é”™è¯¯!"
            exit 1
          fi
          echo "âœ… .SRCINFOç‰ˆæœ¬å·ä¸º: $SRCINFO_VER"

      # ç¬¬ä¹æ­¥ï¼šé…ç½® SSHï¼ˆç”¨äºè¿æ¥ AURï¼‰
      - name: Setup SSH
        run: |
          # åˆ›å»º .ssh ç›®å½•
          mkdir -p ~/.ssh
          # å°† SSH ç§é’¥å†™å…¥æ–‡ä»¶
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur  # è®¾ç½®æ­£ç¡®çš„æƒé™

          # é…ç½® SSH å®¢æˆ·ç«¯
          cat > ~/.ssh/config << EOF
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur      # ä½¿ç”¨çš„ç§é’¥æ–‡ä»¶
            User aur                      # AUR ç”¨æˆ·å
            StrictHostKeyChecking accept-new  # è‡ªåŠ¨æ¥å—æ–°çš„ä¸»æœºå¯†é’¥
          EOF

          # æ·»åŠ  AUR åˆ° known_hosts
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts

      # ç¬¬åæ­¥ï¼šå‘å¸ƒåˆ° AUR
      - name: Publish AUR package
        uses: KSXGitHub/github-actions-deploy-aur@v3.0.1 # ä½¿ç”¨ç¬¬ä¸‰æ–¹ action
        with:
          pkgname: sealantern # AUR åŒ…å
          pkgbuild: PKGBUILD # PKGBUILD æ–‡ä»¶è·¯å¾„
          assets: | # é¢å¤–éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶
            .SRCINFO
            sealantern.install
          commit_username: "${{ github.actor }}" # æäº¤ç”¨æˆ·å
          commit_email: "${{ github.actor }}@users.noreply.github.com" # æäº¤é‚®ç®±
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }} # SSH ç§é’¥
          commit_message: "å·²æ›´æ–°sealanternç‰ˆæœ¬è‡³v${{ steps.get_version.outputs.VERSION }}" # æäº¤ä¿¡æ¯
          allow_empty_commits: false # ä¸å…è®¸ç©ºæäº¤
          force_push: false # ä¸ä½¿ç”¨å¼ºåˆ¶æ¨é€
          updpkgsums: false # ä¸æ›´æ–° checksum
          test: ${{ !github.event.inputs.skip_test }} # æ˜¯å¦è¿è¡Œæµ‹è¯•
          ssh_keyscan_types: rsa,ecdsa,ed25519 # SSH å¯†é’¥ç±»å‹

      # ç¬¬åä¸€æ­¥ï¼šæˆåŠŸé€šçŸ¥
      - name: Send success notification
        if: success() # ä»…å½“ä¹‹å‰æ‰€æœ‰æ­¥éª¤éƒ½æˆåŠŸæ—¶æ‰§è¡Œ
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "======================================"
          echo "âœ… å·²æˆåŠŸæ¨é€sealantern v${VERSION}åˆ°AUR"
          echo "ğŸ“¦ Package URL: https://aur.archlinux.org/packages/sealantern"
          echo "======================================"

      # ç¬¬åäºŒæ­¥ï¼šå¤±è´¥é€šçŸ¥
      - name: Send failure notification
        if: failure() # ä»…å½“æœ‰æ­¥éª¤å¤±è´¥æ—¶æ‰§è¡Œ
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "======================================"
          echo "âŒ æ¨é€sealantern v${VERSION}åˆ°AURå¤±è´¥"
          echo "======================================"

      # ç¬¬åä¸‰æ­¥ï¼šæ¸…ç†å·¥ä½œ
      - name: Cleanup
        if: always() # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
        run: |
          if [ -f "PKGBUILD.bak" ]; then
            echo "Restoring original PKGBUILD"
            rm -f PKGBUILD
            mv PKGBUILD.bak PKGBUILD
            echo "âœ… PKGBUILD restored"
          else
            echo "No backup file found, skipping cleanup"
          fi
