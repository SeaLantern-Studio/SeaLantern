name: Publish to AUR

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g., 1.0.0)"
        required: true
        type: string
      skip_test:
        description: "Skip makepkg test"
        required: false
        default: false
        type: boolean

jobs:
  aur-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y base-devel fakeroot git

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}

      - name: Add AUR to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts

      - name: Get release version
        id: get_version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            # ‰ªé release tag Ëé∑ÂèñÁâàÊú¨
            VERSION=${GITHUB_REF#refs/tags/}
            echo "Source: release tag"
          else
            # ‰ªéÊâãÂä®ËæìÂÖ•Ëé∑ÂèñÁâàÊú¨
            VERSION="${{ github.event.inputs.version }}"
            echo "Source: manual input"
          fi

          # ÁßªÈô§ÂèØËÉΩÁöÑ 'v' ÂâçÁºÄ
          VERSION=${VERSION#v}

          if [[ -z "$VERSION" ]]; then
            echo "Error: Version is empty!"
            echo "GitHub event name: ${{ github.event_name }}"
            echo "Manual input version: ${{ github.event.inputs.version }}"
            echo "GITHUB_REF: $GITHUB_REF"
            exit 1
          fi

          # ËÆæÁΩÆËæìÂá∫ÂèòÈáè - ‰ΩøÁî®Â§öÁßçÊñπÂºèÁ°Æ‰øùÁâàÊú¨Âè∑‰º†ÈÄí
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_ENV
          echo "PKGVER=$VERSION" >> $GITHUB_ENV

          echo "‚úÖ Extracted version: $VERSION"

      - name: Debug version info
        run: |
          echo "Debug information:"
          echo "Event name: ${{ github.event_name }}"
          echo "Version from inputs: ${{ github.event.inputs.version }}"
          echo "Version from get_version output: ${{ steps.get_version.outputs.VERSION }}"
          echo "Version from env.VERSION: ${{ env.VERSION }}"
          echo "Version from env.PKGVER: ${{ env.PKGVER }}"
          echo "GITHUB_REF: $GITHUB_REF"

      - name: Validate PKGBUILD exists
        run: |
          if [ ! -f "PKGBUILD" ]; then
            echo "Error: PKGBUILD file not found!"
            echo "Current directory contents:"
            ls -la
            exit 1
          fi

          echo "‚úÖ PKGBUILD found:"
          head -5 PKGBUILD

      - name: Update PKGBUILD version
        run: |
          # Áõ¥Êé•‰ªéÁéØÂ¢ÉÂèòÈáèËé∑ÂèñÁâàÊú¨Âè∑
          VERSION="${{ env.VERSION }}"

          if [[ -z "$VERSION" ]]; then
            # Â¶ÇÊûúÁéØÂ¢ÉÂèòÈáè‰∏∫Á©∫ÔºåÂ∞ùËØï‰ªé steps.get_version Ëé∑Âèñ
            VERSION="${{ steps.get_version.outputs.VERSION }}"
          fi

          if [[ -z "$VERSION" ]]; then
            echo "Error: VERSION is empty in Update PKGBUILD version step"
            echo "Available environment variables:"
            env | grep -E 'VERSION|PKGVER' || true
            exit 1
          fi

          echo "Updating PKGBUILD to version: $VERSION"

          # Â§á‰ªΩÂéüÂßã PKGBUILD
          cp PKGBUILD PKGBUILD.bak

          # ÊòæÁ§∫ÂΩìÂâç PKGBUILD ‰∏≠ÁöÑÁâàÊú¨
          CURRENT_VER=$(grep "^pkgver=" PKGBUILD | cut -d= -f2 | xargs)
          echo "Current version in PKGBUILD: $CURRENT_VER"

          # Êõ¥Êñ∞ÁâàÊú¨Âè∑
          if grep -q "^pkgver=" PKGBUILD; then
            sed -i "s/^pkgver=.*/pkgver=${VERSION}/" PKGBUILD
            echo "‚úÖ Updated pkgver from $CURRENT_VER to ${VERSION}"
          else
            echo "‚ö†Ô∏è Warning: pkgver not found in PKGBUILD, adding it"
            echo "pkgver=${VERSION}" >> PKGBUILD
          fi

          # ÈáçÁΩÆÂèëÂ∏ÉÂè∑
          if grep -q "^pkgrel=" PKGBUILD; then
            sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
            echo "‚úÖ Reset pkgrel to 1"
          else
            echo "pkgrel=1" >> PKGBUILD
          fi

          # Â¶ÇÊûúÂ≠òÂú® source Êï∞ÁªÑÔºåÊõ¥Êñ∞‰∏ãËΩΩÈìæÊé•‰∏≠ÁöÑÁâàÊú¨Âè∑
          if grep -q "^source=" PKGBUILD; then
            sed -i "s/\${pkgver}/${VERSION}/g" PKGBUILD
            # ‰πüÊõøÊç¢Áõ¥Êé•ÂÜôÊ≠ªÁöÑÁâàÊú¨Âè∑
            if [[ -n "$CURRENT_VER" && "$CURRENT_VER" != "$VERSION" ]]; then
              echo "Replacing old version $CURRENT_VER with $VERSION in source URLs"
              sed -i "s/${CURRENT_VER}/${VERSION}/g" PKGBUILD
            fi
            echo "‚úÖ Updated source URLs"
          fi

          # È™åËØÅÊõ¥Êñ∞
          NEW_VER=$(grep "^pkgver=" PKGBUILD | cut -d= -f2 | xargs)
          echo "New version in PKGBUILD: $NEW_VER"

      - name: Generate .SRCINFO
        run: |
          # Ëé∑ÂèñÁâàÊú¨Âè∑
          VERSION="${{ env.VERSION }}"
          if [[ -z "$VERSION" ]]; then
            VERSION="${{ steps.get_version.outputs.VERSION }}"
          fi

          if [[ -z "$VERSION" ]]; then
            echo "Error: VERSION is empty in Generate .SRCINFO step"
            exit 1
          fi

          echo "Generating .SRCINFO for version: $VERSION"

          # ÂàõÂª∫ .SRCINFO
          cat > .SRCINFO << EOF
            pkgbase = sealantern
            \tpkgdesc = $(grep "^pkgdesc=" PKGBUILD | cut -d= -f2- | xargs)
            \tpkgver = ${VERSION}
            \tpkgrel = 1
            \turl = $(grep "^url=" PKGBUILD | cut -d= -f2- | xargs)
            \tinstall = sealantern.install
            \tarch = $(grep "^arch=" PKGBUILD | cut -d= -f2- | tr -d '()' | xargs)
            \tlicense = $(grep "^license=" PKGBUILD | cut -d= -f2- | tr -d '()' | xargs)
            EOF

          # Ê∑ªÂä† dependsÔºàÂ¶ÇÊûúÊúâÔºâ
          if grep -q "^depends=" PKGBUILD; then
            grep "^depends=" PKGBUILD | cut -d= -f2- | tr -d '()' | tr ' ' '\n' | while read dep; do
              if [[ -n "$dep" ]]; then
                echo "\tdepends = $dep" >> .SRCINFO
              fi
            done
          fi

          # Ê∑ªÂä† makedependsÔºàÂ¶ÇÊûúÊúâÔºâ
          if grep -q "^makedepends=" PKGBUILD; then
            grep "^makedepends=" PKGBUILD | cut -d= -f2- | tr -d '()' | tr ' ' '\n' | while read dep; do
              if [[ -n "$dep" ]]; then
                echo "\tmakedepends = $dep" >> .SRCINFO
              fi
            done
          fi

          # Ê∑ªÂä† sourceÔºàÂ¶ÇÊûúÊúâÔºâ
          if grep -q "^source=" PKGBUILD; then
            grep "^source=" PKGBUILD | cut -d= -f2- | tr -d '()' | tr ' ' '\n' | while read src; do
              if [[ -n "$src" ]]; then
                echo "\tsource = $src" >> .SRCINFO
              fi
            done
          else
            echo "\tsource = PKGBUILD" >> .SRCINFO
          fi

          # Ê∑ªÂä† sha256sumsÔºàÂ¶ÇÊûúÊúâÔºâ
          if grep -q "^sha256sums=" PKGBUILD; then
            grep "^sha256sums=" PKGBUILD | cut -d= -f2- | tr -d '()' | tr ' ' '\n' | while read sum; do
              if [[ -n "$sum" ]]; then
                echo "\tsha256sums = $sum" >> .SRCINFO
              fi
            done
          else
            echo "\tsha256sums = SKIP" >> .SRCINFO
          fi

          echo "" >> .SRCINFO
          echo "pkgname = sealantern" >> .SRCINFO

          echo "‚úÖ Generated .SRCINFO:"
          echo "------------------------"
          cat .SRCINFO
          echo "------------------------"

      - name: Validate files
        run: |
          VERSION="${{ env.VERSION }}"
          if [[ -z "$VERSION" ]]; then
            VERSION="${{ steps.get_version.outputs.VERSION }}"
          fi

          echo "Validating files for version: $VERSION"

          # È™åËØÅ PKGBUILD
          if [ ! -f "PKGBUILD" ]; then
            echo "‚ùå PKGBUILD not found!"
            exit 1
          fi

          PKGVER=$(grep "^pkgver=" PKGBUILD | cut -d= -f2 | xargs)
          if [[ "$PKGVER" != "$VERSION" ]]; then
            echo "‚ùå PKGBUILD version mismatch!"
            echo "  Expected: $VERSION"
            echo "  Found: $PKGVER"
            exit 1
          fi
          echo "‚úÖ PKGBUILD version matches: $PKGVER"

          # È™åËØÅ .SRCINFO
          if [ ! -f ".SRCINFO" ]; then
            echo "‚ùå .SRCINFO not found!"
            exit 1
          fi

          SRCINFO_VER=$(grep "^[[:space:]]*pkgver =" .SRCINFO | head -1 | awk '{print $3}')
          if [[ "$SRCINFO_VER" != "$VERSION" ]]; then
            echo "‚ùå .SRCINFO version mismatch!"
            echo "  Expected: $VERSION"
            echo "  Found: $SRCINFO_VER"
            exit 1
          fi
          echo "‚úÖ .SRCINFO version matches: $SRCINFO_VER"

      - name: Publish AUR package
        uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
        with:
          pkgname: sealantern
          pkgbuild: PKGBUILD
          assets: |
            .SRCINFO
            sealantern.install
          commit_username: "${{ github.actor }}"
          commit_email: "${{ github.actor }}@users.noreply.github.com"
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update sealantern to v${{ env.VERSION }}"
          allow_empty_commits: false
          force_push: false
          updpkgsums: true
          test: ${{ github.event_name == 'release' || !github.event.inputs.skip_test }}
          ssh_keyscan_types: rsa,ecdsa,ed25519

      - name: Send success notification
        if: success()
        run: |
          VERSION="${{ env.VERSION }}"
          echo "======================================"
          echo "‚úÖ Successfully published sealantern v${VERSION} to AUR"
          echo "üì¶ Package URL: https://aur.archlinux.org/packages/sealantern"
          echo "======================================"

      - name: Send failure notification
        if: failure()
        run: |
          VERSION="${{ env.VERSION }}"
          echo "======================================"
          echo "‚ùå Failed to publish sealantern v${VERSION} to AUR"
          echo "Please check the workflow logs for details."
          echo "======================================"

      - name: Cleanup
        if: always()
        run: |
          if [ -f "PKGBUILD.bak" ]; then
            echo "Restoring original PKGBUILD"
            mv PKGBUILD.bak PKGBUILD
          fi
