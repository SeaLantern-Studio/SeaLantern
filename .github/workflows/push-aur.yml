name: Publish to AUR

on:
  push:
    tags:
      - "v*" # ÂåπÈÖç v0.7.3, v1.0.0 Á≠â
      - "sea-lantern-v*" # ÂåπÈÖç sea-lantern-v0.7.3
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g., 1.0.0)"
        required: true
        type: string
      skip_test:
        description: "Skip makepkg test"
        required: false
        default: false
        type: boolean

jobs:
  aur-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential fakeroot git curl wget

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}

      - name: Add AUR to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts

      - name: Debug GitHub context
        run: |
          echo "GitHub Context Debug:"
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref type: ${{ github.ref_type }}"
          echo "Ref name: ${{ github.ref_name }}"
          echo "Release tag: ${{ github.event.release.tag_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"

      - name: Get release version
        id: get_version
        run: |
          # Ê†πÊçÆ‰∫ã‰ª∂Á±ªÂûãËé∑ÂèñÁâàÊú¨
          if [[ "${{ github.event_name }}" == "release" ]]; then
            # Release ‰∫ã‰ª∂ - ‰ªé release tag Ëé∑Âèñ
            VERSION="${{ github.event.release.tag_name }}"
            echo "Source: release tag: $VERSION"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            # Push ‰∫ã‰ª∂Ôºàtag Êé®ÈÄÅÔºâ- ‰ªé ref Ëé∑Âèñ
            VERSION="${{ github.ref_name }}"
            echo "Source: git tag: $VERSION"
          else
            # ÊâãÂä®Ëß¶Âèë - ‰ªéËæìÂÖ•Ëé∑Âèñ
            VERSION="${{ github.event.inputs.version }}"
            echo "Source: manual input: $VERSION"
          fi

          # ÁßªÈô§ÁâàÊú¨Âè∑ÂâçÁöÑ 'v' ÂâçÁºÄÔºàÂ¶ÇÊûúÊúâÔºâ
          VERSION="${VERSION#v}"

          # È™åËØÅÁâàÊú¨Âè∑‰∏ç‰∏∫Á©∫
          if [[ -z "$VERSION" ]]; then
            echo "‚ùå Error: Version is empty!"
            echo "Debug:"
            echo "  event_name: ${{ github.event_name }}"
            echo "  release.tag_name: ${{ github.event.release.tag_name }}"
            echo "  github.ref_name: ${{ github.ref_name }}"
            echo "  inputs.version: ${{ github.event.inputs.version }}"
            exit 1
          fi

          # È™åËØÅÁâàÊú¨Âè∑Ê†ºÂºèÔºàÂèØÈÄâÔºâ
          if ! [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "‚ö†Ô∏è  Warning: Version format may be invalid: $VERSION"
          fi

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_ENV
          echo "‚úÖ Extracted version: $VERSION"

      - name: Validate version
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "Validating version: $VERSION"

          # Ê£ÄÊü• PKGBUILD ‰∏≠ÁöÑÁâàÊú¨Âè∑Ê†ºÂºè
          if grep -q "^pkgver=" PKGBUILD; then
            CURRENT_PKGVER=$(grep "^pkgver=" PKGBUILD | cut -d= -f2 | xargs)
            echo "Current PKGBUILD version: $CURRENT_PKGVER"
          fi

      - name: Debug version info
        run: |
          echo "Debug information:"
          echo "Event name: ${{ github.event_name }}"
          echo "Version from inputs: ${{ github.event.inputs.version }}"
          echo "Version from get_version output: ${{ steps.get_version.outputs.VERSION }}"
          echo "Version from env: ${{ env.version }}"
          echo "GITHUB_REF: ${{ github.ref }}"
          echo "GITHUB_REF_NAME: ${{ github.ref_name }}"

      - name: Validate PKGBUILD exists
        run: |
          if [ ! -f "PKGBUILD" ]; then
            echo "Error: PKGBUILD file not found!"
            echo "Current directory contents:"
            ls -la
            exit 1
          fi
          echo "‚úÖ PKGBUILD found:"
          head -5 PKGBUILD

      - name: Update PKGBUILD version
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          if [[ -z "$VERSION" ]]; then
            echo "Error: VERSION is empty"
            exit 1
          fi

          echo "Updating PKGBUILD to version: $VERSION"

          # Â§á‰ªΩÂéüÂßã PKGBUILD
          cp PKGBUILD PKGBUILD.bak

          # Êõ¥Êñ∞ÁâàÊú¨Âè∑
          sed -i "s/^pkgver=.*/pkgver=${VERSION}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD

          echo "‚úÖ Updated PKGBUILD"
          echo "New version: $(grep ^pkgver= PKGBUILD)"
          echo "New release: $(grep ^pkgrel= PKGBUILD)"

      - name: Generate .SRCINFO
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          echo "Generating .SRCINFO for version: $VERSION"

          # ÂàõÂª∫ .SRCINFO Êñá‰ª∂
          {
            echo "pkgbase = sealantern"

            # Ëé∑Âèñ pkgdesc
            PKGDESC=$(grep "^pkgdesc=" PKGBUILD | cut -d= -f2- | sed "s/^['\"]//;s/['\"]$//" | xargs)
            if [[ -n "$PKGDESC" ]]; then
              echo "	pkgdesc = $PKGDESC"
            fi

            echo "	pkgver = $VERSION"
            echo "	pkgrel = 1"

            # Ëé∑Âèñ url
            URL=$(grep "^url=" PKGBUILD | cut -d= -f2- | xargs)
            if [[ -n "$URL" ]]; then
              echo "	url = $URL"
            fi

            # Ê£ÄÊü•Âπ∂Ê∑ªÂä† install Êñá‰ª∂
            if grep -q "^install=" PKGBUILD; then
              INSTALL=$(grep "^install=" PKGBUILD | cut -d= -f2- | xargs)
              echo "	install = $INSTALL"
            elif [ -f "sealantern.install" ]; then
              echo "	install = sealantern.install"
            fi

            # Ëé∑Âèñ arch
            ARCH=$(grep "^arch=" PKGBUILD | cut -d= -f2- | tr -d '()' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr ' ' '\n' | grep -v '^$')
            if [[ -n "$ARCH" ]]; then
              echo "$ARCH" | while read arch; do
                echo "	arch = $arch"
              done
            fi

            # Ëé∑Âèñ license
            LICENSE=$(grep "^license=" PKGBUILD | cut -d= -f2- | tr -d '()' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr ' ' '\n' | grep -v '^$')
            if [[ -n "$LICENSE" ]]; then
              echo "$LICENSE" | while read license; do
                echo "	license = $license"
              done
            fi

            # Ê∑ªÂä† depends
            if grep -q "^depends=" PKGBUILD; then
              grep "^depends=" PKGBUILD | cut -d= -f2- | tr -d '()' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr ' ' '\n' | while read dep; do
                if [[ -n "$dep" && "$dep" != "(" && "$dep" != ")" ]]; then
                  echo "	depends = $dep"
                fi
              done
            fi

            # Ê∑ªÂä† makedepends
            if grep -q "^makedepends=" PKGBUILD; then
              grep "^makedepends=" PKGBUILD | cut -d= -f2- | tr -d '()' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr ' ' '\n' | while read dep; do
                if [[ -n "$dep" && "$dep" != "(" && "$dep" != ")" ]]; then
                  echo "	makedepends = $dep"
                fi
              done
            fi

            # Ê∑ªÂä† optdepends
            if grep -q "^optdepends=" PKGBUILD; then
              grep "^optdepends=" PKGBUILD | cut -d= -f2- | tr -d '()' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | while read line; do
                if [[ -n "$line" ]]; then
                  echo "	optdepends = $line"
                fi
              done
            fi

            # Ê∑ªÂä† source
            if grep -q "^source=" PKGBUILD; then
              grep "^source=" PKGBUILD | cut -d= -f2- | tr -d '()' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr ' ' '\n' | while read src; do
                if [[ -n "$src" && "$src" != "(" && "$src" != ")" ]]; then
                  echo "	source = $src"
                fi
              done
            fi

            # Ê∑ªÂä† sha256sums
            if grep -q "^sha256sums=" PKGBUILD; then
              grep "^sha256sums=" PKGBUILD | cut -d= -f2- | tr -d '()' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr ' ' '\n' | while read sum; do
                if [[ -n "$sum" && "$sum" != "(" && "$sum" != ")" ]]; then
                  echo "	sha256sums = $sum"
                fi
              done
            fi

            echo ""
            echo "pkgname = sealantern"
          } > .SRCINFO

          echo "‚úÖ Generated .SRCINFO:"
          cat .SRCINFO

      - name: Validate files
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          echo "Validating files for version: $VERSION"

          # È™åËØÅ PKGBUILD
          if [ ! -f "PKGBUILD" ]; then
            echo "‚ùå PKGBUILD not found!"
            exit 1
          fi

          PKGVER=$(grep "^pkgver=" PKGBUILD | cut -d= -f2 | xargs)
          if [[ "$PKGVER" != "$VERSION" ]]; then
            echo "‚ùå PKGBUILD version mismatch!"
            echo "  Expected: $VERSION"
            echo "  Found: $PKGVER"
            exit 1
          fi
          echo "‚úÖ PKGBUILD version matches: $PKGVER"

          # È™åËØÅ .SRCINFO
          if [ ! -f ".SRCINFO" ]; then
            echo "‚ùå .SRCINFO not found!"
            exit 1
          fi

          SRCINFO_VER=$(grep "^[[:space:]]*pkgver =" .SRCINFO | head -1 | awk '{print $3}')
          if [[ "$SRCINFO_VER" != "$VERSION" ]]; then
            echo "‚ùå .SRCINFO version mismatch!"
            echo "  Expected: $VERSION"
            echo "  Found: $SRCINFO_VER"
            exit 1
          fi
          echo "‚úÖ .SRCINFO version matches: $SRCINFO_VER"

          # Ê£ÄÊü•ÂøÖÈúÄÂ≠óÊÆµ
          for field in "pkgdesc" "url" "license" "arch"; do
            if ! grep -q "^[[:space:]]*$field =" .SRCINFO; then
              echo "‚ö†Ô∏è  Warning: $field not found in .SRCINFO"
            fi
          done

          # ÊòæÁ§∫Êñá‰ª∂ÂÜÖÂÆπ‰ª•‰æøË∞ÉËØï
          echo ""
          echo "PKGBUILD content (first 10 lines):"
          head -10 PKGBUILD
          echo ""
          echo ".SRCINFO content:"
          cat .SRCINFO

      - name: Publish AUR package
        uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
        with:
          pkgname: sealantern
          pkgbuild: PKGBUILD
          assets: |
            .SRCINFO
            sealantern.install
          commit_username: "${{ github.actor }}"
          commit_email: "${{ github.actor }}@users.noreply.github.com"
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update sealantern to v${{ steps.get_version.outputs.VERSION }}"
          allow_empty_commits: false
          force_push: false
          updpkgsums: false
          test: false
          ssh_keyscan_types: rsa,ecdsa,ed25519

      - name: Send success notification
        if: success()
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "======================================"
          echo "‚úÖ Successfully published sealantern v${VERSION} to AUR"
          echo "üì¶ Package URL: https://aur.archlinux.org/packages/sealantern"
          echo "======================================"

      - name: Send failure notification
        if: failure()
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "======================================"
          echo "‚ùå Failed to publish sealantern v${VERSION} to AUR"
          echo "Please check the workflow logs for details."
          echo "======================================"

      - name: Cleanup
        if: always()
        run: |
          if [ -f "PKGBUILD.bak" ]; then
            echo "Restoring original PKGBUILD"
            mv PKGBUILD.bak PKGBUILD
          fi
