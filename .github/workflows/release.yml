name: "å‘å¸ƒ"

on:
  workflow_dispatch:
  push:
    branches:
      - release

permissions:
  contents: write

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "macos-latest"
            args: "--target aarch64-apple-darwin"
          - platform: "macos-latest"
            args: "--target x86_64-apple-darwin"
          - platform: "ubuntu-24.04"
            args: ""
          - platform: "windows-latest"
            args: ""

    runs-on: ${{ matrix.platform }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Ubuntu ä¸“ç”¨)
        if: matrix.platform == 'ubuntu-24.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: ç¼“å­˜ Rust ç¼–è¯‘äº§ç‰©
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: å®‰è£…å‰ç«¯ä¾èµ– (npm)
        # é»˜è®¤ç”¨npm,æœ€ç¨³å¦¥
        run: npm install

      - name: æ„å»ºå¹¶å‘å¸ƒ
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: sea-lantern-v__VERSION__
          releaseName: "Sea Lantern v__VERSION__"
          releaseBody: |
            ## ğŸ‰ å‘å¸ƒ Sea Lantern v__VERSION__

            è¯·åœ¨æ­¤å¤„æ·»åŠ å‘å¸ƒè¯´æ˜ã€‚
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}

  # Arch Linux æ‰“åŒ…ä»»åŠ¡ - æ ¹æ®æ‚¨çš„ PKGBUILD ä¼˜åŒ–
  build-arch-package:
    needs: publish-tauri
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… ç‰ˆæœ¬å·: $VERSION"

      - name: ä¸‹è½½ Ubuntu æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: ubuntu-build
          path: ./downloads
        continue-on-error: true

      - name: æŸ¥æ‰¾ deb åŒ…
        id: find_deb
        run: |
          if [ -d "./downloads" ]; then
            DEB_FILE=$(find ./downloads -name "*.deb" -type f | head -1)
          fi
          if [ -z "$DEB_FILE" ]; then
            DEB_FILE=$(find . -name "*.deb" -type f | head -1)
          fi
          if [ -z "$DEB_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° deb åŒ…æ–‡ä»¶"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ° deb åŒ…: $DEB_FILE"
          cp "$DEB_FILE" ./sealantern.deb
          echo "DEB_FILE=$DEB_FILE" >> $GITHUB_OUTPUT

      - name: è®¾ç½® Arch Linux å®¹å™¨å¹¶å®‰è£…å®Œæ•´ä¾èµ–
        run: |
          docker run --name arch-builder -d \
            -v $PWD:/workspace \
            archlinux:latest \
            sleep infinity

          # æ ¹æ®æ‚¨çš„ PKGBUILD å®‰è£…æ‰€æœ‰ depends å’Œ makedepends
          docker exec arch-builder bash -c "
            pacman -Syu --noconfirm && \
            pacman -S --noconfirm \
              # åŸºç¡€å¼€å‘å·¥å…· (makedepends)
              base-devel \
              binutils \
              file \
              findutils \
              grep \
              sed \
              gawk \
              dpkg \
              \
              # GTK ç›¸å…³åŸºç¡€ä¾èµ–
              cairo \
              gdk-pixbuf2 \
              glib2 \
              gtk3 \
              pango \
              atk \
              libgl \
              \
              # WebKit ç›¸å…³ä¾èµ–
              webkit2gtk \
              libsoup \
              \
              # ç³»ç»Ÿå›¾æ ‡ä¸»é¢˜
              hicolor-icon-theme \
              adwaita-icon-theme \
              \
              # æ¡Œé¢æ–‡ä»¶ç›¸å…³
              desktop-file-utils \
              shared-mime-info \
              \
              # å®‰å…¨ç›¸å…³
              libxss \
              nss \
              nspr \
              \
              # ç³»ç»Ÿæ‰˜ç›˜æ”¯æŒ
              libayatana-appindicator \
              libappindicator-gtk3 \
              \
              # ç½‘ç»œç›¸å…³
              curl \
              wget \
              openssl \
              ca-certificates \
              gnutls \
              \
              # å›¾å½¢ç›¸å…³
              libx11 \
              libxcb \
              libxcomposite \
              libxcursor \
              libxdamage \
              libxext \
              libxfixes \
              libxi \
              libxrandr \
              libxrender \
              libxtst \
              \
              # å­—ä½“æ”¯æŒ
              fontconfig \
              freetype2 \
              \
              # éŸ³é¢‘æ”¯æŒ
              alsa-lib \
              libpulse \
              \
              # æ•°æ®åº“æ”¯æŒ
              sqlite3 \
              \
              # å‹ç¼©æ”¯æŒ
              zlib \
              bzip2 \
              xz \
              \
              # å…¶ä»–å¸¸ç”¨åº“
              expat \
              libffi \
              pcre \
              pcre2 \
              libgcrypt \
              libgpg-error \
              libdatrie \
              libthai \
              libice \
              libsm \
              util-linux \
              util-linux-libs
          "
          echo "âœ… Arch Linux å®¹å™¨ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ä½¿ç”¨æ‚¨çš„ PKGBUILD æ„å»º Arch åŒ…
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          # å°†æ‚¨çš„ PKGBUILD å’Œ sealantern.install æ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨
          docker cp sealantern.deb arch-builder:/workspace/
          docker cp PKGBUILD arch-builder:/workspace/
          # å¦‚æœå­˜åœ¨ sealantern.install æ–‡ä»¶ï¼Œä¹Ÿå¤åˆ¶è¿‡å»
          [ -f "sealantern.install" ] && docker cp sealantern.install arch-builder:/workspace/

          # åœ¨å®¹å™¨ä¸­æ‰§è¡Œæ‰“åŒ…ï¼Œä½¿ç”¨æ‚¨çš„åŸå§‹ PKGBUILD
          docker exec arch-builder bash -c "
            cd /workspace && \
            chown -R builder:builder . && \

            # æ›´æ–° PKGBUILD ä¸­çš„ç‰ˆæœ¬å·ï¼ˆç¡®ä¿ä¸å½“å‰ç‰ˆæœ¬ä¸€è‡´ï¼‰
            sed -i 's/^pkgver=.*/pkgver=$VERSION/' PKGBUILD && \
            sed -i 's/^pkgrel=.*/pkgrel=1/' PKGBUILD && \

            # ä»¥ builder ç”¨æˆ·è¿è¡Œ makepkg ç”Ÿæˆæœ€ç»ˆåŒ…
            sudo -u builder makepkg -f --noconfirm
          "

      - name: ä»å®¹å™¨ä¸­è·å–æ„å»ºäº§ç‰©
        run: |
          # å¤åˆ¶ç”Ÿæˆçš„åŒ…æ–‡ä»¶ï¼ˆå¯èƒ½æ˜¯ .pkg.tar.zst æˆ– .pkg.tar.xzï¼‰
          docker cp arch-builder:/workspace/*.pkg.tar.* . || true

          if ls *.pkg.tar.* 1> /dev/null 2>&1; then
            echo "âœ… Arch åŒ…ç”ŸæˆæˆåŠŸ"
            ls -la *.pkg.tar.*
          else
            echo "âŒ Arch åŒ…ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

      - name: åœæ­¢å¹¶åˆ é™¤å®¹å™¨
        if: always()
        run: |
          docker stop arch-builder || true
          docker rm arch-builder || true

      - name: ä¸Šä¼  Arch åŒ…åˆ° Release
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: sea-lantern-v${{ steps.get_version.outputs.VERSION }}
          files: |
            *.pkg.tar.*
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼  Arch åŒ…ä½œä¸ºæ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: arch-package
          path: |
            *.pkg.tar.*
