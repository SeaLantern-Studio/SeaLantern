name: 'å‘å¸ƒ Tauri æ¡Œé¢åº”ç”¨'

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'å‘å¸ƒæ ‡ç­¾ (ä¾‹å¦‚ v0.4.1) - å¦‚æžœä¸å¡«åˆ™è‡ªåŠ¨ä»Žç‰ˆæœ¬å·ç”Ÿæˆ'
        required: false
        default: ''
      prerelease:
        description: 'æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false
      draft:
        description: 'åˆ›å»ºä¸ºè‰ç¨¿å‘å¸ƒï¼ˆéœ€æ‰‹åŠ¨å‘å¸ƒï¼‰'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  get-version:
    name: èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
    runs-on: ubuntu-latest
    outputs:
      app-version: ${{ steps.get-version.outputs.app-version }}
      app-name: ${{ steps.get-version.outputs.app-name }}
      release-tag: ${{ steps.get-version.outputs.release-tag }}
    steps:
      - uses: actions/checkout@v4

      - name: ä»Ž tauri.conf.json è¯»å–åº”ç”¨ç‰ˆæœ¬å’Œåç§°
        id: get-version
        run: |
          VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
          PRODUCT_NAME=$(jq -r '.productName' src-tauri/tauri.conf.json)
          echo "app-version=$VERSION" >> $GITHUB_OUTPUT
          echo "app-name=$PRODUCT_NAME" >> $GITHUB_OUTPUT
          
          # Use provided tag or generate from version
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="v$VERSION"
          fi
          echo "release-tag=$TAG" >> $GITHUB_OUTPUT
          
          echo "::notice title=å‘å¸ƒä¿¡æ¯::ðŸ“¦ ç‰ˆæœ¬: $VERSION | ðŸ“› åº”ç”¨å: $PRODUCT_NAME | ðŸ·ï¸ æ ‡ç­¾: $TAG"

  publish-tauri:
    name: æž„å»ºä¸Žå‘å¸ƒ (${{ matrix.platform }})
    needs: get-version
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            target: 'macos-aarch64'
            build-name: 'macOS ARM64 (M1/M2/M3)'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            target: 'macos-x64'
            build-name: 'macOS Intel x64'
          # Linux
          - platform: 'ubuntu-22.04'
            args: ''
            target: 'linux-x64'
            build-name: 'Linux x64'
          # Windows
          - platform: 'windows-latest'
            args: ''
            target: 'windows-x64'
            build-name: 'Windows x64'

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£…ä¾èµ– (Ubuntu ä¸“ç”¨)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev

      - name: å®‰è£… Bun
        uses: oven-sh/setup-bun@v1

      - name: å®‰è£… Rust ç¨³å®šç‰ˆ
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust ç¼“å­˜
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: bun install

      - name: æž„å»ºä¸Žç­¾ç½² Tauri åº”ç”¨ (${{ matrix.build-name }})
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Windows signing
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
          # macOS signing
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          tagName: ${{ needs.get-version.outputs.release-tag }}
          releaseName: '${{ needs.get-version.outputs.app-name }} ${{ needs.get-version.outputs.release-tag }}'
          releaseBody: |
            # ${{ needs.get-version.outputs.app-name }} ${{ needs.get-version.outputs.release-tag }}
            
            **ç‰ˆæœ¬**: ${{ needs.get-version.outputs.app-version }}
            
            ## ðŸŽ‰ å‘å¸ƒäº®ç‚¹
            
            è¯·åœ¨æ­¤æ·»åŠ å‘å¸ƒè¯´æ˜Žå’Œäº®ç‚¹æè¿°ã€‚
            
            ## ðŸ“¥ ä¸‹è½½
            
            è¯·æ ¹æ®ä½ çš„ç³»ç»Ÿå¹³å°é€‰æ‹©åˆé€‚çš„å®‰è£…åŒ…ï¼š
            
            ### ðŸªŸ Windows
            - **Sea-Lantern_${{ needs.get-version.outputs.app-version }}_x64-setup.msi** - Windows ç‰ˆæœ¬å®‰è£…ç¨‹åºï¼ˆæŽ¨èï¼‰
            
            ### ðŸŽ macOS
            - **Sea-Lantern_${{ needs.get-version.outputs.app-version }}_aarch64.dmg** - è‹¹æžœèŠ¯ç‰‡ç‰ˆ (M1, M2, M3 ç­‰)
            - **Sea-Lantern_${{ needs.get-version.outputs.app-version }}_x64.dmg** - Intel èŠ¯ç‰‡ç‰ˆ
            - **Sea-Lantern_${{ needs.get-version.outputs.app-version }}_x64.app.tar.gz** - åŽ‹ç¼©æ ¼å¼å¤‡é€‰
            
            ### ðŸ§ Linux
            - **sea-lantern_${{ needs.get-version.outputs.app-version }}_x86_64.AppImage** - é€šç”¨ç‰ˆ (é€‚ç”¨äºŽå¤§å¤šæ•° Linux å‘è¡Œç‰ˆ)
            - **sea-lantern_${{ needs.get-version.outputs.app-version }}_amd64.deb** - Debian/Ubuntu ç³»åˆ—
            - **sea-lantern-${{ needs.get-version.outputs.app-version }}-1.x86_64.rpm** - Fedora/RHEL ç³»åˆ—
            
            ## âœ¨ åŠŸèƒ½ç‰¹æ€§
            
            - æ”¯æŒå¤šå¹³å° (Windows, macOS, Linux)
            - åŽŸç”Ÿæ¡Œé¢åº”ç”¨
            - é«˜æ•ˆå¿«é€Ÿ
            
            ## ðŸ”‘ æ•°å­—ç­¾åä¸ŽéªŒè¯
            
            æ‰€æœ‰ç‰ˆæœ¬å‡ä½¿ç”¨å¯†é’¥ç­¾åï¼š
            - **Windows**: Microsoft Authenticode ç­¾å
            - **macOS**: Apple Developer ID ç­¾å
            - **Linux**: AppImage è‡ªè§£åŽ‹æ ¼å¼
          releaseDraft: ${{ github.event.inputs.draft || true }}
          prerelease: ${{ github.event.inputs.prerelease || false }}
          args: ${{ matrix.args }}

  build-linux-bundles:
    name: æž„å»º Linux åŒ… (AppImage, deb, rpm)
    needs: get-version
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev

      - name: å®‰è£… Bun
        uses: oven-sh/setup-bun@v1

      - name: å®‰è£… Rust ç¨³å®šç‰ˆ
        uses: dtolnay/rust-toolchain@stable

      - name: Rust ç¼“å­˜
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: bun install

      - name: æž„å»ºå‰ç«¯
        run: bun run build

      - name: æž„å»º Linux åŒ… (AppImage, deb, rpm)
        run: |
          echo "ðŸ§ Building AppImage..."
          bun run tauri build -- --bundles appimage
          
          echo "ðŸ“¦ Building Debian packages..."
          bun run tauri build -- --bundles deb
          
          echo "ðŸ“¦ Building RPM packages..."
          bun run tauri build -- --bundles rpm

      - name: åˆ—å‡ºæž„å»ºçš„äº§ç‰©
        run: |
          echo "::group::å·²æž„å»ºçš„äº§ç‰©"
          find src-tauri/target/release/bundle -type f \( -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" \) -exec ls -lh {} \;
          echo "::endgroup::"

      - name: ä¸Šä¼ äº§ç‰©ä»¥ä¾›å‘å¸ƒ
        uses: actions/upload-artifact@v4
        with:
          name: linux-bundles-${{ needs.get-version.outputs.app-version }}
          path: |
            src-tauri/target/release/bundle/appimage/
            src-tauri/target/release/bundle/deb/
            src-tauri/target/release/bundle/rpm/
          retention-days: 1
          compression-level: 0

  upload-to-release:
    name: ä¸Šä¼ äº§ç‰©åˆ°å‘å¸ƒ
    needs: [get-version, publish-tauri, build-linux-bundles]
    permissions:
      contents: write
    runs-on: ubuntu-latest
    if: success()
    steps:
      - uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: åˆ—å‡ºæ‰€æœ‰å·²ä¸‹è½½çš„äº§ç‰©
        run: |
          echo "::group::æ‰€æœ‰äº§ç‰©"
          find artifacts -type f
          echo "::endgroup::"

      - name: é‡å‘½å Linux äº§ç‰©å¹¶æ·»åŠ ç‰ˆæœ¬åŽç¼€
        run: |
          VERSION="${{ needs.get-version.outputs.app-version }}"
          APP_NAME="sea-lantern"
          
          # Create temporary directory for renamed files
          mkdir -p release-artifacts
          
          # Copy and rename artifacts
          echo "ðŸ“ Renaming artifacts with version suffix..."
          
          # AppImage files
          if find artifacts -name "*.AppImage" -type f 2>/dev/null | grep -q .; then
            for file in $(find artifacts -name "*.AppImage" -type f); do
              filename=$(basename "$file")
              # Format: app_VERSION_ARCH.AppImage
              newname="${APP_NAME}_${VERSION}_$(basename "$file" | sed -E 's/_[^_]*\.AppImage/_/; s/([a-z0-9]+)\.AppImage/\1.AppImage/')"
              cp "$file" "release-artifacts/$newname"
              echo "  âœ“ AppImage: $newname"
            done
          fi
          
          # Debian files (.deb)
          if find artifacts -name "*.deb" -type f 2>/dev/null | grep -q .; then
            for file in $(find artifacts -name "*.deb" -type f); do
              filename=$(basename "$file")
              # Extract architecture from filename (amd64, arm64, etc.)
              arch=$(echo "$filename" | grep -oE '[a-z0-9]+\.deb' | sed 's/\.deb//')
              newname="${APP_NAME}_${VERSION}_${arch}.deb"
              cp "$file" "release-artifacts/$newname"
              echo "  âœ“ DEB: $newname"
            done
          fi
          
          # RPM files
          if find artifacts -name "*.rpm" -type f 2>/dev/null | grep -q .; then
            for file in $(find artifacts -name "*.rpm" -type f); do
              filename=$(basename "$file")
              # Extract architecture from RPM filename
              arch=$(echo "$filename" | grep -oE '\.(x86_64|aarch64|ppc64le|s390x|armv7l)\.rpm' | sed 's/\.//g; s/\.rpm//')
              newname="${APP_NAME}-${VERSION}-1.${arch}.rpm"
              cp "$file" "release-artifacts/$newname"
              echo "  âœ“ RPM: $newname"
            done
          fi
          
          # Copy Windows and macOS artifacts (from tauri-action, already in releases)
          echo ""
          echo "âœ… Linux artifacts staged for upload:"
          ls -lh release-artifacts/ || echo "No Linux artifacts found"

      - name: å‡†å¤‡å‘å¸ƒè¯´æ˜Žä¸Žæ ¡éªŒå’Œ
        run: |
          cat > release-notes.md << 'EOF'
          # ${{ needs.get-version.outputs.app-name }} ${{ needs.get-version.outputs.release-tag }}
          
          **ç‰ˆæœ¬**: ${{ needs.get-version.outputs.app-version }}
          **å‘å¸ƒæ—¥æœŸ**: $(date -u +'%Y-%m-%d %H:%M UTC')
          
          ## ðŸŽ‰ å‘å¸ƒäº®ç‚¹
          
          è¯·åœ¨æ­¤å¤„æ·»åŠ å‘å¸ƒè¯´æ˜Žå’Œäº®ç‚¹æè¿°ã€‚
          
          ### ä¸»è¦æ›´æ–°
          - æ–°åŠŸèƒ½ 1
          - ä¿®å¤é—®é¢˜ 1
          - æ€§èƒ½æ”¹è¿› 1
          
          ## ðŸ“¥ ä¸‹è½½é“¾æŽ¥
          
          ### ðŸªŸ Windows
          | æ–‡ä»¶ | è¯´æ˜Ž |
          |------|------|
          | Sea-Lantern_${{ needs.get-version.outputs.app-version }}_x64-setup.msi | Windows x64 å®‰è£…ç¨‹åºï¼ˆæŽ¨èï¼‰ |
          
          ### ðŸŽ macOS
          | æ–‡ä»¶ | æž¶æž„ | è¯´æ˜Ž |
          |------|--------|------|
          | Sea-Lantern_${{ needs.get-version.outputs.app-version }}_aarch64.dmg | Apple Silicon | é€‚ç”¨äºŽçŽ°ä»£ Mac (M1/M2/M3) |
          | Sea-Lantern_${{ needs.get-version.outputs.app-version }}_x64.dmg | Intel x64 | é€‚ç”¨äºŽ Intel èŠ¯ç‰‡ Mac |
          
          ### ðŸ§ Linux
          | æ–‡ä»¶ | æ ¼å¼ | å‘è¡Œç‰ˆ |
          |------|--------|--------|
          | sea-lantern_${{ needs.get-version.outputs.app-version }}_x86_64.AppImage | AppImage | é€šç”¨ (å¤§å¤šæ•°å‘è¡Œç‰ˆ) |
          | sea-lantern_${{ needs.get-version.outputs.app-version }}_amd64.deb | Debian | Ubuntuã€Debian |
          | sea-lantern-${{ needs.get-version.outputs.app-version }}-1.x86_64.rpm | RPM | Fedoraã€RHELã€CentOS |
          
          ## ðŸ” éªŒè¯ä¸Žç­¾å
          
          æ‰€æœ‰ç‰ˆæœ¬å‡é€šè¿‡å¯†é’¥è¿›è¡Œç­¾åï¼š
          - **Windows**: Microsoft Authenticode ç­¾å
          - **macOS**: Apple Developer ID ç­¾å
          - **Linux**: GPG ç­¾åï¼ˆå¦‚é€‚ç”¨ï¼‰
          
          ## ðŸ“‹ ç³»ç»Ÿè¦æ±‚
          
          - **Windows**: Windows 7 æˆ–æ›´é«˜ç‰ˆæœ¬ (x64)
          - **macOS**: macOS 10.13 æˆ–æ›´é«˜ç‰ˆæœ¬
          - **Linux**: glibc 2.29 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆå¤§å¤šæ•°çŽ°ä»£å‘è¡Œç‰ˆï¼‰
          
          ## ðŸ†˜ æ”¯æŒå¸®åŠ©
          
          å¦‚æœ‰é—®é¢˜æˆ–ç–‘é—®ï¼Œè¯·è®¿é—® [GitHub Issues](../../issues)
          EOF
          cat release-notes.md

      - name: ä¸Šä¼  Linux äº§ç‰©åˆ°å‘å¸ƒ
        uses: softprops/action-gh-release@v2
        if: always()
        with:
          tag_name: ${{ needs.get-version.outputs.release-tag }}
          draft: ${{ github.event.inputs.draft || true }}
          prerelease: ${{ github.event.inputs.prerelease || false }}
          files: release-artifacts/*
          body_path: release-notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  finalize:
    name: å®Œæˆå‘å¸ƒ
    needs: [get-version, upload-to-release]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: å‘å¸ƒå®Œæˆæ‘˜è¦
        run: |
          cat << EOF
          âœ… å‘å¸ƒå·¥ä½œæµå·²æˆåŠŸå®Œæˆï¼
          
          ðŸ“¦ å‘å¸ƒä¿¡æ¯:
            - åº”ç”¨åç§°: ${{ needs.get-version.outputs.app-name }}
            - åº”ç”¨ç‰ˆæœ¬: ${{ needs.get-version.outputs.app-version }}
            - å‘å¸ƒæ ‡ç­¾: ${{ needs.get-version.outputs.release-tag }}
            - è‰ç¨¿æ¨¡å¼: ${{ github.event.inputs.draft || true }}
            - é¢„å‘å¸ƒæ ‡è®°: ${{ github.event.inputs.prerelease || false }}
          
          ðŸ“ åŽç»­æ­¥éª¤:
            1. å‰å¾€: https://github.com/${{ github.repository }}/releases/tag/${{ needs.get-version.outputs.release-tag }}
            2. å®¡æ ¸å‘å¸ƒè¯´æ˜Žå’Œæž„å»ºäº§ç‰©
            3. æ ¹æ®éœ€è¦ç¼–è¾‘å‘å¸ƒè¯´æ˜Ž
            4. ç‚¹å‡»"Publish release"æŒ‰é’®å‘å¸ƒæ­£å¼ç‰ˆæœ¬
          
          EOF
