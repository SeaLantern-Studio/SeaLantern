name: Build and Upload to PPA

on:
  push:
    branches:
      - ppa-deploy
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.6.5)'
        required: true
        default: '0.6.5'

jobs:
  build-ppa-packages:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        distro: [noble, jammy, focal]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg wget devscripts dput gnupg build-essential fakeroot debhelper

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION for ${{ matrix.distro }}"

      - name: Download Sea Lantern deb
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          wget -O "Sea.Lantern_${VERSION}_amd64.deb" \
            "https://github.com/SeaLantern-Studio/SeaLantern/releases/download/sea-lantern-v${VERSION}/Sea.Lantern_${VERSION}_amd64.deb"

      - name: Build PPA package for ${{ matrix.distro }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          DISTRO="${{ matrix.distro }}"
          Package_VERSION="${{ steps.version.outputs.VERSION }}~${{ matrix.distro }}1"
          
          PACKAGE_DIR="./ppa-build/sea-lantern-ppa-updater_${Package_VERSION}"
          
          rm -rf "./ppa-build"
          mkdir -p "$PACKAGE_DIR/DEBIAN"
          mkdir -p "$PACKAGE_DIR/opt/sealantern"
          
          cp "Sea.Lantern_${VERSION}_amd64.deb" "$PACKAGE_DIR/opt/sealantern/"
          
          TOTAL_SIZE=$(du -sk "$PACKAGE_DIR" | cut -f1)
          
          cat > "${PACKAGE_DIR}/DEBIAN/control" << CONTROL
          Package: sea-lantern-ppa-updater
          Version: ${Package_VERSION}
          Section: utils
          Priority: optional
          Architecture: amd64
          Depends: dpkg, binutils, libwebkit2gtk-4.1-0, libgtk-3-0, libappindicator3-1, libssl3, ca-certificates
          Installed-Size: ${TOTAL_SIZE}
          Maintainer: Brian Ikun <2914651630@qq.com>
          Homepage: https://github.com/SeaLantern-Studio/SeaLantern
          Description: Sea Lantern PPA Installer
           This package downloads and installs Sea Lantern from official GitHub Releases.
           It's designed for PPA distribution to provide easy installation of Sea Lantern.
           .
           Sea Lantern is a lightweight Minecraft server management tool
           based on Tauri 2 + Rust + Vue 3.
          CONTROL
          
          cat > "${PACKAGE_DIR}/DEBIAN/postinst" << 'POSTINST'
          #!/bin/bash
          
          # 获取嵌入的 deb 版本
          PACKAGE_VERSION=$(dpkg -s sea-lantern-ppa-updater 2>/dev/null | grep Version | awk '{print $2}' | sed 's/~.*$//')
          if [ -z "$PACKAGE_VERSION" ]; then
              PACKAGE_VERSION="0.6.5"
          fi
          
          EMBEDDED_DEB="/opt/sealantern/Sea.Lantern_${PACKAGE_VERSION}_amd64.deb"
          
          echo "正在安装 Sea Lantern ${PACKAGE_VERSION}..."
          
          if [ -f "$EMBEDDED_DEB" ]; then
              # 直接解压 deb 文件到系统根目录
              dpkg-deb -x "$EMBEDDED_DEB" /
              
              # 尝试获取包信息并注册
              CONTROL=$(dpkg-deb -e "$EMBEDDED_DEB" /tmp/sealantern-control 2>/dev/null && cat /tmp/sealantern-control/control)
              if [ -n "$CONTROL" ]; then
                  # 创建简单的包注册文件
                  mkdir -p /var/lib/dpkg/info
                  echo "$CONTROL" > /var/lib/dpkg/info/sealantern.control
                  echo "Package: sealantern" > /var/lib/dpkg/status.d/sealantern
                  echo "Status: install ok installed" >> /var/lib/dpkg/status.d/sealantern
                  echo "$CONTROL" | grep -v "^Package:" >> /var/lib/dpkg/status.d/sealantern
              fi
              
              rm -rf /tmp/sealantern-control
              rm -f "$EMBEDDED_DEB"
              
              echo "✅ Sea Lantern 安装成功！"
              echo "运行命令: sea-lantern"
          else
              echo "❌ 找不到嵌入的包文件: $EMBEDDED_DEB"
          fi
          POSTINST
          
          chmod +x "${PACKAGE_DIR}/DEBIAN/postinst"
          
          cat > "${PACKAGE_DIR}/DEBIAN/prerm" << 'PRERM'
          #!/bin/bash
          if [ "$1" = "remove" ] || [ "$1" = "purge" ]; then
              echo "正在卸载 Sea Lantern..."
              dpkg -l | grep -q sealantern && dpkg -r sealantern || true
          fi
          PRERM
          
          chmod +x "${PACKAGE_DIR}/DEBIAN/prerm"
          
          dpkg-deb --build "$PACKAGE_DIR"
          
          echo "✅ ${DISTRO} package created: ${PACKAGE_DIR}.deb"

      - name: Setup GPG
        run: |
          echo "${{ secrets.PPA_GPG_PRIVATE_KEY }}" | gpg --batch --import --pinentry-mode loopback --passphrase "${{ secrets.PPA_GPG_PASSPHRASE }}"
          
          # Get the full 40-character fingerprint
          GPG_FINGERPRINT=$(gpg --list-secret-keys --with-fingerprint --with-colons | grep '^fpr' | head -1 | cut -d: -f10)
          
          echo "GPG_FINGERPRINT=$GPG_FINGERPRINT" >> $GITHUB_ENV
          
          export GNUPGHOME=~/.gnupg
          chmod 700 ~/.gnupg

      - name: Create source package for PPA
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          DISTRO="${{ matrix.distro }}"
          Package_VERSION="${{ steps.version.outputs.VERSION }}~${{ matrix.distro }}1"
          
          # Create source package directory - must match package name
          SOURCE_DIR="./ppa-source/sea-lantern-ppa-updater_${Package_VERSION}"
          rm -rf ./ppa-source
          mkdir -p "${SOURCE_DIR}"
          
          # Copy the binary deb
          cp "./ppa-build/sea-lantern-ppa-updater_${Package_VERSION}.deb" "${SOURCE_DIR}/"
          
          # Create debian directory
          mkdir -p "${SOURCE_DIR}/debian/source"
          
          cat > "${SOURCE_DIR}/debian/control" << EOF
          Source: sea-lantern-ppa-updater
          Section: utils
          Priority: optional
          Maintainer: Brian Ikun <2914651630@qq.com>
          Build-Depends: debhelper-compat (= 12)
          Standards-Version: 4.4.1
          Homepage: https://github.com/SeaLantern-Studio/SeaLantern
          
          Package: sea-lantern-ppa-updater
          Architecture: amd64
          Depends: \${shlibs:Depends}, \${misc:Depends},
                   dpkg, binutils, libwebkit2gtk-4.1-0, libgtk-3-0, libappindicator3-1, libssl3, ca-certificates
          Description: Sea Lantern PPA Installer
           This package downloads and installs Sea Lantern from official GitHub Releases.
           It's designed for PPA distribution to provide easy installation of Sea Lantern.
           .
           Sea Lantern is a lightweight Minecraft server management tool
           based on Tauri 2 + Rust + Vue 3.
          EOF
          
          cat > "${SOURCE_DIR}/debian/changelog" << EOF
          sea-lantern-ppa-updater (${Package_VERSION}) ${DISTRO}; urgency=medium
          
            * New upstream release ${VERSION}
            * Auto-synced from SeaLantern-Studio/SeaLantern
            * Built for ${DISTRO}
          
           -- Brian Ikun <2914651630@qq.com>  $(date -R)
          EOF
          
          cat > "${SOURCE_DIR}/debian/rules" << 'RULES'
          #!/usr/bin/make -f
          %:
          	dh $@
          
          override_dh_auto_build:
          	# Binary already built
          
          override_dh_auto_install:
          	dpkg -x sea-lantern-ppa-updater_*.deb debian/sea-lantern-ppa-updater
          RULES
          chmod +x "${SOURCE_DIR}/debian/rules"
          
          # Only use debhelper-compat, do NOT create debian/compat file
          echo "3.0 (native)" > "${SOURCE_DIR}/debian/source/format"
          
          cd "${SOURCE_DIR}"
          
          # Build source package WITHOUT signing using dpkg-buildpackage
          export DEBEMAIL="2914651630@qq.com"
          export DEBFULLNAME="Brian Ikun"
          
          dpkg-buildpackage -us -uc -S -sa
          
          # Now sign the files manually using debsign with passphrase via stdin
          cd ..
          
          echo "${{ secrets.PPA_GPG_PASSPHRASE }}" | debsign -k"$GPG_FINGERPRINT" -p"gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0" "sea-lantern-ppa-updater_${Package_VERSION}_source.changes"

      - name: Upload to PPA
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          DISTRO="${{ matrix.distro }}"
          Package_VERSION="${{ steps.version.outputs.VERSION }}~${{ matrix.distro }}1"
          
          cd ppa-source
          
          echo "Uploading ${DISTRO} package to PPA..."
          dput ppa:brianeee7878/sealantern "sea-lantern-ppa-updater_${Package_VERSION}_source.changes"
          
          echo "✅ Successfully uploaded ${DISTRO} package to PPA"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sea-lantern-ppa-updater-${{ matrix.distro }}
          path: |
            ppa-build/sea-lantern-ppa-updater_*.deb
            ppa-source/*.dsc
            ppa-source/*.tar.xz
            ppa-source/*.changes