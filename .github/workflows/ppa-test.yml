name: PPA Package Test

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to test (e.g., 0.6.5)'
        required: true
        default: '0.6.5'
      distro:
        description: 'Ubuntu distro to test (noble, jammy, focal)'
        required: true
        default: 'noble'
  schedule:
    # æ¯6å°æ—¶æ£€æŸ¥ä¸€æ¬¡ PPA åŒ…çŠ¶æ€
    - cron: '0 */6 * * *'

jobs:
  test-ppa-package:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:${{ github.event.inputs.distro || 'noble' }}
      options: --privileged

    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y curl wget gnupg software-properties-common dpkg

      - name: Add PPA and install package
        run: |
          # æ·»åŠ  PPA
          add-apt-repository ppa:brianeee7878/sealantern -y
          apt-get update

          # å®‰è£…åŒ…
          echo "Installing sea-lantern-ppa-updater..."
          apt-get install -y sea-lantern-ppa-updater

      - name: Verify installation
        run: |
          echo "=== éªŒè¯å®‰è£…ç»“æœ ==="

          # æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
          if [ -f "/usr/bin/sea-lantern" ]; then
            echo "âœ… /usr/bin/sea-lantern å­˜åœ¨"
          else
            echo "âŒ /usr/bin/sea-lantern ä¸å­˜åœ¨"
            exit 1
          fi

          # æ£€æŸ¥æ¡Œé¢æ–‡ä»¶
          if [ -f "/usr/share/applications/Sea Lantern.desktop" ]; then
            echo "âœ… /usr/share/applications/Sea Lantern.desktop å­˜åœ¨"
          else
            echo "âŒ æ¡Œé¢æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

          # æ£€æŸ¥å›¾æ ‡
          ICON_FOUND=false
          for size in 32x32 64x64 128x128 256x256; do
            if [ -f "/usr/share/icons/hicolor/${size}/apps/sealantern.png" ]; then
              echo "âœ… å›¾æ ‡ ${size} å­˜åœ¨"
              ICON_FOUND=true
            fi
          done
          if [ "$ICON_FOUND" = false ]; then
            echo "âš ï¸  æœªæ‰¾åˆ°å›¾æ ‡æ–‡ä»¶"
          fi

          # æ£€æŸ¥åµŒå…¥çš„ deb æ˜¯å¦è¢«æ¸…ç†
          if ls /opt/sealantern/Sea.Lantern_*.deb 2>/dev/null; then
            echo "âš ï¸  åµŒå…¥çš„ deb åŒ…æœªè¢«åˆ é™¤"
          else
            echo "âœ… åµŒå…¥çš„ deb åŒ…å·²æ¸…ç†"
          fi

          echo ""
          echo "=== æµ‹è¯•å‘½ä»¤æ‰§è¡Œ ==="
          sea-lantern --version 2>/dev/null || echo "âš ï¸  æ— æ³•è·å–ç‰ˆæœ¬ï¼ˆå¯èƒ½éœ€è¦å›¾å½¢ç¯å¢ƒï¼‰"

      - name: Check PPA status via API
        run: |
          echo "=== PPA çŠ¶æ€æ£€æŸ¥ ==="

          # è·å– PPA ä¿¡æ¯
          echo "PPA åŸºæœ¬ä¿¡æ¯:"
          curl -s "https://api.launchpad.net/1.0/~brianeee7878/+archive/ubuntu/sealantern" | \
            python3 -c "import sys,json; d=json.load(sys.stdin); print(f\"  åç§°: {d.get('displayname')}\"); print(f\"  ç­¾åæŒ‡çº¹: {d.get('signing_key_fingerprint')}\")"

          # è·å–å·²å‘å¸ƒçš„æºç åŒ…
          echo ""
          echo "å·²å‘å¸ƒçš„æºç åŒ…:"
          curl -s "https://api.launchpad.net/1.0/~brianeee7878/+archive/ubuntu/sealantern?ws.op=getPublishedSources" | \
            python3 -c "import sys,json; d=json.load(sys.stdin); [print(f\"  - {e.get('display_name')} [{e.get('status')}]\") for e in d.get('entries',[]) if e.get('status')=='Published']"

          # è·å–æ„å»ºè®°å½•
          echo ""
          echo "æœ€è¿‘çš„æ„å»ºè®°å½•:"
          curl -s "https://api.launchpad.net/1.0/~brianeee7878/+archive/ubuntu/sealantern?ws.op=getBuildRecords" | \
            python3 -c "import sys,json; d=json.load(sys.stdin); [print(f\"  - {e.get('title')}: {e.get('buildstate')}\") for e in d.get('entries',[])][:5]"

      - name: Create GitHub Issue if test fails
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš¨ PPA Package Test Failed - ${new Date().toISOString()}`;
            const body = `## PPA åŒ…æµ‹è¯•å¤±è´¥

            - æµ‹è¯•æ—¶é—´: ${new Date().toISOString()}
            - ç‰ˆæœ¬: ${{ github.event.inputs.version || 'latest' }}
            - å‘è¡Œç‰ˆ: ${{ github.event.inputs.distro || 'noble' }}
            - å·¥ä½œæµ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            è¯·æ£€æŸ¥:
            1. PPA åŒ…æ˜¯å¦æ­£ç¡®æ„å»º
            2. å®‰è£…è„šæœ¬æ˜¯å¦æ­£å¸¸æ‰§è¡Œ
            3. ä¾èµ–é¡¹æ˜¯å¦å®Œæ•´

            cc @brianikim`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'ppa', 'automated']
            });

  monitor-ppa-status:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Check PPA build status
        run: |
          echo "=== ç›‘æ§ PPA æ„å»ºçŠ¶æ€ ==="

          # è·å–å¤±è´¥çš„æ„å»º
          curl -s "https://api.launchpad.net/1.0/~brianeee7878/+archive/ubuntu/sealantern?ws.op=getBuildRecords" | \
            python3 -c "
import sys,json
d=json.load(sys.stdin)
failed = [e for e in d.get('entries',[]) if e.get('buildstate') != 'Successfully built']
if failed:
    print('âš ï¸  å‘ç°å¤±è´¥çš„æ„å»º:')
    for e in failed[:5]:
        print(f\"  - {e.get('title')}: {e.get('buildstate')}\")
        print(f\"    æ—¥å¿—: {e.get('build_log_url')}\")
else:
    print('âœ… æ‰€æœ‰æ„å»ºéƒ½æˆåŠŸ')
"

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `âš ï¸ PPA Build Monitor Alert - ${new Date().toISOString()}`;
            const body = `## PPA æ„å»ºç›‘æ§å‘Šè­¦

            æ£€æµ‹åˆ° PPA æ„å»ºå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ Launchpad ä¸Šçš„æ„å»ºçŠ¶æ€ã€‚

            - æ—¶é—´: ${new Date().toISOString()}
            - PPA: https://launchpad.net/~brianeee7878/+archive/ubuntu/sealantern

            cc @brianikim`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['ppa', 'monitoring', 'automated']
            });
